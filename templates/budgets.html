{% extends "base.html" %}

{% block title %}Budgets - MoneyMuse{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-3">Budgets for {{ user.username }}</h2>
    <p class="text-muted">Plan, monitor, and control your spending effectively.</p>

    <!--  Flash Messages -->
    <!-- {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %} -->

    <!--  Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm p-3 text-center">
                <h6 class="text-muted">Total Budget</h6>
                <h4 class="fw-bold text-primary">Rs. {{ total_budget or 0 }}</h4>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3 text-center">
                <h6 class="text-muted">Total Spent</h6>
                <h4 class="fw-bold text-danger">Rs. {{ total_spent or 0 }}</h4>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3 text-center">
                <h6 class="text-muted">Remaining</h6>
                <h4 class="fw-bold text-success">Rs. {{ (total_budget - total_spent) if total_budget else 0 }}</h4>
            </div>
        </div>
    </div>

    <!-- ✅ Add Budget Form -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">+ Add a New Budget</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('add_budget') }}">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Amount (Rs.)</label>
                        <input type="number" step="0.01" name="amount" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Period</label>
                        <select name="period" class="form-select">
                            <option value="monthly">Monthly</option>
                            <option value="weekly">Weekly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select" required>
                            <option value="">-- Select Category --</option>
                            {% for c in all_categories %}
                                <option value="{{ c.name }}">{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Start Date</label>
                        <input type="date" name="start_date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">End Date</label>
                        <input type="date" name="end_date" class="form-control">
                    </div>
                </div>
                <div class="mt-3 text-end">
                    <button type="submit" class="btn btn-primary">Save Budget</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ✅ Existing Budgets -->
    <h3 class="mb-3">Existing Budgets</h3>
    {% if budget_progress %}
        <div class="list-group">
        {% for item in budget_progress %}
            <div class="list-group-item">
                <strong>{{ item.budget.name }}</strong> - Rs. {{ item.budget.amount }} ({{ item.budget.period }})
                {% if item.budget.category %} | Category: {{ item.budget.category.name }} {% endif %}
                {% if item.budget.start_date %} | From: {{ item.budget.start_date }} {% endif %}
                {% if item.budget.end_date %} | To: {{ item.budget.end_date }} {% endif %}

                <!-- Progress Bar -->
                <div class="progress mt-2" style="height: 20px;">
                    <div class="progress-bar 
                        {% if item.progress < 75 %}bg-success
                        {% elif item.progress < 100 %}bg-warning
                        {% else %}bg-danger{% endif %}"
                        role="progressbar"
                        style="width: {{ item.progress }}%">
                        {{ item.progress }}%
                    </div>
                </div>

                <!-- Alert if exceeded -->
                {% if item.exceeded %}
                <div class="alert alert-danger mt-2 p-2">
                    ⚠️ You’ve exceeded your budget by Rs. {{ item.spent - item.budget.amount }}
                </div>
                {% endif %}

                <!-- Edit/Delete Buttons -->
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editBudgetModal{{ item.budget.id }}">
                        Edit
                    </button>
                    <form method="POST" action="{{ url_for('delete_budget', budget_id=item.budget.id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('Are you sure you want to delete this budget?')">
                            Delete
                        </button>
                    </form>
                </div>
            </div>

            <!-- Edit Modal -->
            <div class="modal fade" id="editBudgetModal{{ item.budget.id }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form method="POST" action="{{ url_for('edit_budget', budget_id=item.budget.id) }}">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title">Edit Budget</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" value="{{ item.budget.name }}" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" name="amount" class="form-control" value="{{ item.budget.amount }}" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Period</label>
                        <select name="period" class="form-select">
                            <option value="monthly" {% if item.budget.period=='monthly' %}selected{% endif %}>Monthly</option>
                            <option value="weekly" {% if item.budget.period=='weekly' %}selected{% endif %}>Weekly</option>
                            <option value="yearly" {% if item.budget.period=='yearly' %}selected{% endif %}>Yearly</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select" required>
                            {% for c in all_categories %}
                                <option value="{{ c.name }}" {% if item.budget.category and c.id == item.budget.category.id %}selected{% endif %}>
                                    {{ c.name }}
                                </option>
                            {% endfor %}
                        </select>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
        {% endfor %}
        </div>
    {% else %}
        <p><em>No budgets set yet.</em></p>
    {% endif %}
</div>
{% endblock %}
