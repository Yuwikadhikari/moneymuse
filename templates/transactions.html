{% extends "base.html" %}
{% block title %}Transactions - MoneyMuse{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container py-4">
    <!-- Page Header -->
    <div class="text-center mb-5">
        <h2 class="fw-bold">üí∞ Manage <span style="color: var(--primary)">Transactions</span></h2>
        <p class="text-muted">Add, review, and analyze your income and expenses ‚Äî all in one place.</p>
    </div>

    <div class="row g-4">
        <!-- Left Side: Form + Transactions -->
        <div class="col-lg-6">
            <!-- Add Transaction -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">‚ûï Add New Transaction</h5>
                    <form method="POST" action="{{ url_for('add_transaction') }}">
                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.01" name="amount" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select name="type" class="form-select">
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <div class="d-flex">
                                <select name="category_id" class="form-select me-2" required>
                                    {% for c in all_categories %}
                                        <option value="{{ c.id }}">{{ c.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                    +
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Note</label>
                            <input type="text" name="note" class="form-control">
                        </div>

                        <!-- Recurring -->
                        <div class="mb-3">
                            <label class="form-label">Recurring?</label>
                            <select name="is_recurring" class="form-select" onchange="toggleFrequency(this)">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>

                        <div class="mb-3" id="frequencyDiv" style="display:none;">
                            <label class="form-label">Frequency</label>
                            <select name="frequency" class="form-select">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-success w-100">Add Transaction</button>
                    </form>
                </div>
            </div>

            <!-- Transactions List -->
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">üìú Transactions History</h5>
                        <div class="d-flex gap-2">
                            <!-- Export Button -->
                            <a href="{{ url_for('export_transactions') }}" class="btn btn-outline-success btn-sm">
                                Export CSV
                            </a>
                            <!-- Hide Button -->
                            <button id="toggleTransactions" class="btn btn-outline-secondary btn-sm">Hide</button>
                        </div>
                    </div>

                    <div id="transactionsContainer">
                        {% if transactions %}
                        <ul class="list-group">
                            {% for t in transactions %}
                            <li class="list-group-item d-flex justify-content-between align-items-center 
                                {% if t.type == 'income' %}transaction-income{% else %}transaction-expense{% endif %}">
                                <div>
                                    <strong>{{ t.type.capitalize() }}</strong> ‚Äì Rs. {{ t.amount }}
                                    {% if t.note %}<small class="text-muted">({{ t.note }})</small>{% endif %}
                                </div>
                                <span class="text-muted small">{{ t.date.strftime('%Y-%m-%d %I:%M %p') }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                            <p class="text-muted"><em>No transactions found</em></p>
                        {% endif %}
                    </div>

                    <div id="hiddenMessage" class="text-center text-muted" style="display:none;">
                        <em>Transactions are hidden</em>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side: Charts -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h6 class="mb-3">üìä Income vs Expenses</h6>
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="mb-3">üç© Expenses by Category</h6>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('add_category') }}">
        <div class="modal-header">
          <h5 class="modal-title">Add Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Category Name</label>
            <input type="text" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Type</label>
            <select name="type" class="form-select" required>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Category</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Custom Styles -->
<style>
/* Light mode */
.transaction-income {
  background: rgba(40, 167, 69, 0.1);
  border-left: 5px solid #28a745;
}
.transaction-expense {
  background: rgba(220, 53, 69, 0.1);
  border-left: 5px solid #dc3545;
}

/* Dark mode */
body.dark-mode .transaction-income {
  background: rgba(40, 167, 69, 0.2);
  color: #d4f8d4;
}
body.dark-mode .transaction-expense {
  background: rgba(220, 53, 69, 0.2);
  color: #f8d7da;
}
</style>

<!-- Scripts -->
<script>
function toggleFrequency(select) {
    document.getElementById("frequencyDiv").style.display =
        (select.value === "yes") ? "block" : "none";
}

document.addEventListener("DOMContentLoaded", () => {
    const toggleBtn = document.getElementById("toggleTransactions");
    const transactionsDiv = document.getElementById("transactionsContainer");
    const hiddenMsg = document.getElementById("hiddenMessage");

    toggleBtn.addEventListener("click", () => {
        if (transactionsDiv.style.display === "none") {
            transactionsDiv.style.display = "block";
            hiddenMsg.style.display = "none";
            toggleBtn.textContent = "Hide";
        } else {
            transactionsDiv.style.display = "none";
            hiddenMsg.style.display = "block";
            toggleBtn.textContent = "Show";
        }
    });
});

/* Bar Chart */
const ctxBar = document.getElementById('barChart').getContext('2d');
new Chart(ctxBar, {
    type: 'bar',
    data: {
        labels: ['Income', 'Expenses'],
        datasets: [{
            label: 'Amount (Rs.)',
            data: [{{ total_income }}, {{ total_expense }}],
            backgroundColor: ['#36A2EB', '#FF6384']
        }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
});

/* Pie Chart */
const ctxPie = document.getElementById('pieChart').getContext('2d');
new Chart(ctxPie, {
    type: 'doughnut',
    data: {
        labels: {{ categories | tojson }},
        datasets: [{
            data: {{ amounts | tojson }},
            backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40']
        }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});
</script>
{% endblock %}
